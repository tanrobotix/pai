# Rest Server

*Current this doc only contains rest-server public API.*
*Before read this part, please refer [API Gateway](../../../mtExternalService/Openresty/docs/APIGW_Api.md) to get right API gateway URL to call.*

## Configuration files

Configure the rest server environment variable in [env.ini](../../../src/rest-server/env.ini).


key | Description | Default value
--|:--|:--
PAI_REST_SERVER_EXIT_SPEC_PATH|Exit info spec path. No need for MT, remain here to be compatible with open PAI| test/data/exit-spec.yaml
SERVER_URI|Rest server root uri|http://RestServer{@subcluster}-iVIP.{@environment}.{@cluster}.ap.gbl
LAUNCHER_WEBSERVICE_URI|Launcher web service uri|http://launcher{@subcluster}-vip.{@environment}.{@cluster}.ap.gbl:86
HDFS_URI|The hdfs path|hdfs://namenode{@subcluster}-ivip.{@environment}.{@cluster}.ap.gbl
WEBHDFS_URI|Web hdfs uri. No need for MT|http://10.151.40.234:5070
YARN_URI|RM web service uri|http://resourcemanager{@subcluster}-ivip.{@environment}.{@cluster}.ap.gbl
JWT_SECRET|JWT secret, used for encrtpy password|nihao
DEFAULT_PAI_ADMIN_USERNAME|No need for MT|core
DEFAULT_PAI_ADMIN_PASSWORD|No need for MT|PhillyOnAzure001
LAUNCHER_TYPE|Framework launcher type|yarn
AUTHN_METHOD|User authentication method. OIDC or basic| OIDC
SERVER_PORT|Rest server port|9186
GROUP_CONFIG_PATH|Group configurtaion file path|group.yaml
SERVICE_NAME|Service name. mt or pai| mt
JOB_DRIVER_TAG|Job driver tag|MPJD
JOB_REFRESH_INTERVAL|The job list refresh time interval. unit is seconds|60
OIDC_CONFIG_PATH|OIDC config file path|oidc.ini.flattened.ini
DATA_CENTER|Data center current rest server starts on|BASIC-{@cluster} or MTPRIME-{@cluster}
JOB_TAG_TYPE_DESCRIPTION|Job type and tag dictionary. Separted by \| |{"tag" : "livy-batch", "type":"LIVY-BATCH"}|{"tag" : "livy-session", "type":"LIVY-SESSION"}
USER_STORAGE_TYPE|User and group data storage type. zookeeper or k8sSecret |zookeeper
USER_STORAGE_PREFIX|User data root path.|mtuser
GROUP_STORAGE_PREFIX|Group data root path.|usergroup
MTZK_DETECTSERVICE_URI|MTZK detect service uri|use CH1 MTZK for testing, CH1B MTZK for production.
K8S_APISERVER_URI|Kubernetes api server uri. No need for MT util we transfer user and group data to zookeeper|http://127.0.0.1:9999
*ZOOKEEPER_CONNECTION_STR*|Zookeeper connection string. In current service it will be **generated by calling MTZK_DETECTSERVICE_URI in start.bat file**|use CH1 MTZK for testing, CH1B MTZK for production.


Configure the AAD stuff in [oidc.ini](../../../src/rest-server/oidc.ini).
Configure the group information in [group.yaml](../../../src/rest-server/group.yaml).

## Root URI

http://RestServer{@subCluster}-iVIP.{@environment}.{@cluster}.ap.gbl

## API Details

### GetToken
Verify and decode the provided [MT Token](https://msasg.visualstudio.com/Multi%20Tenancy/_git/DataDeployment?path=%2Fprivate%2FASG_MTP%2FMTToken%2FREADME.md&version=GBmaster&_a=preview).

*Request*

```json
GET /api/v2/token

Headers: {
    Authorization: 'Bearer ${token}',
}
```


*Response if succeeded*

Status: 200

Body Schema:

Body Field | Description
--|:--
userName|The MT UserName.<br>Normally, it is your microsoft alias.
admin|Whether the user is MT Admin.<br>MT Admin has a lot of privileges, such as impersonate to be other users.
issueEpoch|The epoch time at which the MT Token was issued.
expiryEpoch|The epoch time at or after which the MT Token expired.
issuer|Who issued the token.
audience|Intended recipient of the token.
originType|The type of trust source based on which the MT Token is signed.<br>For example, it can be:<br>  AAD: The MT Token is signed based on the trust of AAD.<br>  MT: The MT Token is signed based on the trust of another MT Token.
originUserName|Get the MT UserName of trust source based on which the MT Token is signed.<br>If the MT Token is signed by the user itself, it is the same as the userName, otherwise it is the MT UserName who signed the MT Token by impersonation.

Body Example:
```json
{
    "userName": "your-alias",
    "admin": false,
    "issueEpoch": 1582255794,
    "expiryEpoch": 1592255794,
    "issuer": "restserver.magnetar",
    "audience": "magnetar",
    "originType": "AAD",
    "originUserName": "your-alias"
}
```

*Response if not authorized*

Status: 401

Body Example-1:
```json
{
    "code": "UnauthorizedUserError",
    "message": "Invalid Token: JsonWebTokenError: invalid signature"
}
```

Body Example-2:
```json
{
    "code": "UnauthorizedUserError",
    "message": "Invalid Token: TokenExpiredError: jwt expired"
}
```

### PostToken
Create a new [MT Token](https://msasg.visualstudio.com/Multi%20Tenancy/_git/DataDeployment?path=%2Fprivate%2FASG_MTP%2FMTToken%2FREADME.md&version=GBmaster&_a=preview) based on an existing MT Token.

*Request*

```json
POST /api/v2/token

Headers: {
    Authorization: 'Bearer ${existing token}',
}
```

Body Schema:

Body Field | Description | Default Value
--|:--|:--
userName|The new token's userName field.<br>Only MT Admin can set it to non-default value|The existing token's userName field.
admin|The new token's admin field.<br>Only MT Admin can set it to non-default value|false
expiryDurationSecs|The new token will be expired in next expiryDurationSecs seconds|

Body Example-1:

Create another token for you which will be expired in next 10000000 seconds.
```json
{
	"expiryDurationSecs": 10000000
}
```

Body Example-2:

Create another token for another admin user which will be expired in next 10000000 seconds.

```json
{
	"userName": "other-alias",
	"admin": true,
	"expiryDurationSecs": 10000000
}
```

*Response if succeeded*

Status: 200

Body Example:
```json
{
    "token": "the-new-token-string"
}
```

*Response if not authorized*

Status: 401

Body Example-1:
```json
{
    "code": "UnauthorizedUserError",
    "message": "Invalid Token: JsonWebTokenError: invalid signature"
}
```

*Response if bad request*

Status: 400

Body Example-1:
```json
{
    "code": "UnknownError",
    "message": "Current user [normal-user-alias] cannot get admin token"
}
```

Body Example-2:
```json
{
    "code": "UnknownError",
    "message": "Current user [normal-user-alias] cannot impersonate user [another-user-alias]"
}
```


### `GET all jobs`

Get the list of all merged jobs.

*Request*

```json
GET /api/v2/mp/jobs
Headers: {
    Authorization: 'Bearer ${token}',
}
```

*Query Parameters*

```json
{
  "username": "filter jobs with username" // optional
}
```
```json
{
  "virtualCluster": "filter jobs with virtualCluster" // optional
}
```

*Response if succeeded*

```json
Status: 200

{
  "mergedJobs": [
    {
      name: "jobName",
      appId: "application_id",
      username: "user name",
      state: "job state:preparing,waiting,running,finishing,succeeded,stopping,stopped,failed,archived...",
      executionType: "execution type",
      retries: job total retry count,
      createdTime: "createdTimestamp",
      completedTime: "completedTimestamp",
      appExitCode: applicationExitCode,
      virtualCluster: "virtual cluster",
      // For compatible with PAI
      totalGpuNumber: total GPU number,
      totalTaskNumber: total task number,
      totalTaskRoleNumber: total task role number,
      jobType: "job type",
      jobDetailLink: "job detail page link. It's a relevant link",
      runningDataCenter: "running data center",
      appTrackingUrl: "application tracking url",
      appExitDiagnostics: "application exit diagnostic info",
      appTag: "application tag",
      allocatedMB: current allocated memory,
      allocatedVCores: current allocated VCore number,
      priority: job priority,
      applicationProgress: "current application progress",
      groupId: "the id for job group",
    },
    ...
  ]
}
```

*Response if a server error occurred*

```json
Status: 500

{
  "code": "UnknownError",
  "message": "*Upstream error messages*"
}
```

### `GET Job by name`

Get job status by jobname in the system. **Only support the job was submitted from market place and the job name obey launcher framework name's rule.**

*Request*

```json
GET /api/v2/mp/jobs/jobName/:jobName
Headers: {
    Authorization: 'Bearer ${token}',
}
```

*Response if succeeded*

```json
Status: 200

{
  jobStatus : {
    name: "jobName",
    appId: "application_id",
    username: "username",
    state: "job state",
    attemptState: "job attempt state",
    executionType: "execution type",
    retries: job total retry count,
    version: "job version",
    attemptId: "job attemptId",
    retryDetails: {
      // Job failed due to user or unknown error
      user: userRetries,
      // Job failed due to platform error
      platform: platformRetries,
      // Job cannot get required resource to run within timeout
      resource: resourceRetries,
    },
    createdTime: "createdTimestamp",
    completedTime: "completedTimestamp",
    appExitCode: applicationExitCode,
    virtualCluster: "virtual cluster",
    // For compatible with PAI
    totalGpuNumber: total GPU number,
    totalTaskNumber: total task number,
    totalTaskRoleNumber: total task role number,
    jobType: "job type",
    jobDetailLink: "job detail page link. It's a relevant link",
    runningDataCenter: "running data center",
    appTrackingUrl: "application tracking url",
    appExitDiagnostics: "application exit diagnostic info",
    appTag: "application tag",
    allocatedMB: current allocated memory,
    allocatedVCores: current allocated VCore number,
    priority: job priority,
    applicationProgress: "current application progress",
    queuePercentageUseage: "current job queue usage percentage",
    reservcedMB: "job reserved memory",
    utilizedMB: "job utilized memory",
    reservcedVCores: "job reserved vcore",
    utilizedVCores: "job utilized vcore",
    reservedContainers: "job reserved container count",
    runningContianers: "current running container count",
    pendingContaines: "current pending container count",
    preemptedResourceMB: "preempt memory number",
    preemptedResourceVCores: "preempt vcore number",
    numNonAMContainerPreempted: "preempt contianer number exclude AM",
    numAMContainerPreempted: "preempt AM number",
    latestAttemptId: "the latest attempt id",
    jobFullDetailUrl: "job detail page link. It's a obsolute link",
    amContainerLogs: "check if AM container started",
    webportalLink: "Full URL for job detail page on webportal",
    groupId: "the id for job group",
  }
}
```

*Response if the job does not exist*

```json
Status: 404

{
  "code": "NoJobError",
  "message": "Job $jobname is not found."
}
```

*Response if a server error occurred*

```json
Status: 500

{
  "code": "UnknownError",
  "message": "*Upstream error messages*"
}
```

### `GET /appId/:appId`

**Get job status by application Id.**

*Request*

```json
GET /api/v2/mp/jobs/appId/:appId
Headers: {
    Authorization: 'Bearer ${token}',
}
```

*Response if succeeded*

```json
Status: 200

{
  jobStatus : {
    name: "jobName",
    appId: "application_id",
    username: "username",
    state: "job state",
    executionType: "execution type",
    retries: job retry count,
    retryDetails: {
      // Job failed due to user or unknown error
      user: userRetries,
      // Job failed due to platform error
      platform: platformRetries,
      // Job cannot get required resource to run within timeout
      resource: resourceRetries,
    },
    createdTime: "createdTimestamp",
    completedTime: "completedTimestamp",
    appExitCode: applicationExitCode,
    virtualCluster: "virtual cluster",
    // For compatible with PAI
    totalGpuNumber: total GPU number,
    totalTaskNumber: total task number,
    totalTaskRoleNumber: total task role number,
    jobType: "job type",
    jobDetailLink: "job detail page link. It's a relevant link",
    runningDataCenter: "running data center",
    appTrackingUrl: "application tracking url",
    appExitDiagnostics: "application exit diagnostic info",
    appTag: "application tag",
    allocatedMB: current allocated memory,
    allocatedVCores: current allocated VCore number,
    priority: job priority,
    applicationProgress: "current application progress",
    queuePercentageUseage: "current job queue usage percentage",
    reservcedMB: "job reserved memory",
    utilizedMB: "job utilized memory",
    reservcedVCores: "job reserved vcore",
    utilizedVCores: "job utilized vcore",
    reservedContainers: "job reserved container count",
    runningContianers: "current running container count",
    pendingContaines: "current pending container count",
    preemptedResourceMB: "preempt memory number",
    preemptedResourceVCores: "preempt vcore number",
    numNonAMContainerPreempted: "preempt contianer number exclude AM",
    numAMContainerPreempted: "preempt AM number",
    latestAttemptId: "the latest attempt id",
    jobFullDetailUrl: "job detail page link. It's a obsolute link",
    amContainerLogs: "check if AM container started",
    webportalLink: "Full URL for job detail page on webportal",
    groupId: "the id for job group",
  }
}
```

*Response if the job does not exist*

```json
Status: 404

{
  "code": "NoJobError",
  "message": "Job $jobname is not found."
}
```

*Response if a server error occurred*

```json
Status: 500

{
  "code": "UnknownError",
  "message": "*Upstream error messages*"
}
```

### `PUT /jobName/:jobName/executionType`

Stop a job by job name. Only support launcher job.

*Request*

```json
PUT /api/v2/mp/jobs/jobName/:jobName/executionType
Headers: {
    Authorization: 'Bearer ${token}',
}
Body: {
    "value": "STOP"
}

```

*Response if succeeded*

```json
Status: 202

{
  "message": "execute job $jobName successfully"
}
```

*Response if the job does not exist*

```json
Status: 404

{
  "code": "NoJobError",
  "message": "Job $jobname is not found."
}
```

*Response if a server error occurred*

```json
Status: 500

{
  "code": "UnknownError",
  "message": "*Upstream error messages*"
}
```
### `PUT /appId/:appId/executionType`

Stop a job.

*Request*

```json
PUT /api/v2/mp/jobs/appId/:appId/executionType
Headers: {
    Authorization: 'Bearer ${token}',
}
Body: {
    "value": "STOP"
}
```

*Response if succeeded*

```json
Status: 202

{
  "message": "execute job $jobName successfully"
}
```

*Response if the job does not exist*

```json
Status: 404

{
  "code": "NoJobError",
  "message": "Job $jobname is not found."
}
```

*Response if a server error occurred*

```json
Status: 500

{
  "code": "UnknownError",
  "message": "*Upstream error messages*"
}
```

Market place


### Get module info API
To fetch module related info, parameters, interface and so on.

*Request*

```json
GET /api/v2/mp/modules/{moduleId}
Headers: {
    Authorization: 'Bearer ${token}',
}
```

*Query Parameters*
```json
schema=
    json - add "$schema" to paramters for format check
```

next(createError('Internal Server Error', 'UnknownError', err));
*Response if succeeded*
```json
Status: 200
{
'info': '<m id="26bcc5e0-5f90-4f24-9e97-61f935e42511" ..... i="run.bat -_Name &quot;(Name:default,run_multiple_exe)&quot; -_ScriptWebPath &quot;(ScriptWebPath:default,hdfs://namenode0-ivip.yarn-prod-bn2.bn2.ap.gbl/user/sike/Aether/Script/SplitText.zip)&quot; -_DataWebDir &quot;(DataWebDir:default,hdfs://namenode0-ivip.yarn-prod-co4.co4.ap.gbl/projects/MT/AetherModule/Tmp/data/e1c66550-6d03-4734-8d60-e8daaa7bcf37/a.txt)&quot; -_ModelWebDir &quot;[(ModelWebDir)]&quot; -_ImageWebPath &quot;[(ImageWebPath:default,hdfs://namenode0-ivip.yarn-prod-bn2.bn2.ap.gbl/user/sike/Aether/Image/python3.zip)]&quot; -_EntranceFileName (EntranceFileName:default,SplitText.py) -_StartArguments &quot;[(StartupArguments:default,p1 p2 p3)]&quot; -_OutputHdfsTargetDir &quot;(OutputHdfsTargetDir:default,hdfs://namenode0-ivip.yarn-prod-co4.co4.ap.gbl/projects/MT/AetherModule/Tmp/data)&quot; ...... -_OutputHdfsDir {out:AnyFile:OutputHdfsDir}" ... />',
'detail': '{"id":"26bcc5e0-5f90-4f24-9e97-61f935e42511","name":"[Multitenancy] Run Multiple Exe","description":"Launch multiple Windows processes managed by Yarn and control the instance lifecycle. This module is usually used for distributed model serving or data processing.","version":"2.9.42","owner":"FAREAST\sike","status":"active","category":"other job","parameters": {"Name": {"hidden": "true"}, "ScriptWebPath": {"description": "The HDFS/Cosmos path contain customer's script/code, must be a zip file. will download and unzip to MT AP machine."}, "DataWebDir": {"description": "The HDFS/Cosmos directory contains your data"}, "ModelWebDir": {"description": "The HDFS/Cosmos directory URL containing your model and other files needed, will just down to local and pass the local path to customer's code. if needn't, just let it empty"}, ....  "YarnSwitches": {"description": ""}, "OutputHdfsDir": {"description": "HDFS directory, each data piece is stored under this directory."}}}',
"parameters": {
    "ScriptWebPath": {
        "required": "true",
        "type": "string",
        "default": "hdfs://namenode0-ivip.yarn-prod-bn2.bn2.ap.gbl/user/sike/Aether/Script/SplitText.zip",
        "description": "The HDFS/Cosmos path contain customer's script/code, must be a zip file. will download and unzip to MT AP machine."
    },
    "DataWebDir": {
        "required": "true",
        "type": "string",
        "default": "hdfs://namenode0-ivip.yarn-prod-co4.co4.ap.gbl/projects/MT/AetherModule/Tmp/data/e1c66550-6d03-4734-8d60-e8daaa7bcf37/a.txt",
        "description": "The HDFS/Cosmos directory contains your data"
    },
    "ModelWebDir": {
        "required": "false",
        "type": "string",
        "description": "The HDFS/Cosmos directory URL containing your model and other files needed, will just down to local and pass the local path to customer's code. if needn't, just let it empty"
    }
....
}
```

*Response if the job does not exist*
```json
HTTP 404 Not Found
{}
```

*Response if a server error occurred*
Status: 500
```json
{
  "code": "UnknownError",
  "message": "*Upstream error messages*"
}
```

### To submit a module job

*Request*

```json
POST /api/v2/mp/jobs
Headers: {
    Authorization: 'Bearer ${token}',
}
Body: {
    'FrameworkName':'t-jisun_97c4a173223fae89c48f1c43a9eb8bc4_sike_test_multiple_exe-_2019-7-20-23-3-59', // optional
    'JobGroupId':'group1', // optional
    'ModuleId':'26bcc5e0-5f90-4f24-9e97-61f935e42511', //required
    'Parameters': {
        'parameterName1':'parameterValue1',
        'parameterName2':'parameterValue2',
    }
}
```

*Response if succeeded*

```json
Status 200
{
  'frameworkName': 't-jisun_97c4a173223fae89c48f1c43a9eb8bc4_sike_test_multiple_exe-_2019-7-20-23-3-59',
  'webportalLink': 'https://magnetar/job-detail.html?jobName=t-jisun_97c4a173223fae89c48f1c43a9eb8bc4_sike_test_multiple_exe-_2019-7-20-23-3-59&subCluster=BASIC-PROD-BN2-0',
  'groupId': 'the id for job group',
  ...
}
```

*Response if user has no permission*

```json
Status: 403

{
  "code": "ForbiddenUserError",
  "message": "User $username is not allowed to add job to $vcname
}
```

*Response if there is a duplicated job submission*

```json
Status: 409

{
  "code": "ConflictJobError",
  "message": "Job name $jobname already exists."
}
```

*Response if a server error occurred*

```json
Status: 500

{
  "code": "UnknownError",
  "message": "*Upstream error messages*"
}
```

### Get module list

*Request*
```json
GET api/v2/mp/modules
Headers: {
    Authorization: 'Bearer ${token}',
}
```

*Response if succeeded*
```json
Status: 200
{
    "moduleList": [
        {
            "id": "0c3e337e-89c0-4b64-8788-6703199fa324",
            "name": "[Multitenancy] Spark.Net on MT for MP",
            "description": "Run Spark.Net job on MT",
            "version": "0.0.1",
            "owner": "FAREAST\\yipen",
            "status": "active",
            "category": "Spark Job",
        },
        {
            "id": "26bcc5e0-5f90-4f24-9e97-61f935e42511",
            "name": "[Multitenancy] Run Multiple Exe",
            "description": "Launch multiple Windows processes managed by Yarn and control the instance lifecycle. This module is usually used for distributed model serving or data processing.",
            "version": "2.9.42",
            "owner": "FAREAST\\sike",
            "status": "active",
            "category": "other job",
        }
    ]
}
```

### Get example list

*Request*
```json
GET api/v2/mp/examples
Headers: {
    Authorization: 'Bearer ${token}',
}
```

*Response if succeeded*
```json
Status: 200
{
    "data": [
        {
            "info": {
                "id": "User-example-SparkOnYarn",
                "name": "Separate user log to another file",
                "category": "spark",
                "moduleId": "f9f1ba97-477c-4a11-9650-016d1999cc4e",
                "description": "test"
            },
            "parameters": {
                "App_JarRelativePath": "UserlogLog4jExample.jar",
                "App_MainClass": "mt.example.Log4jUserLogExample",
                "Job_DelHDFSDataOnSucc": "false",
                "Job_MaxRetryNum": 1,
                "Job_Queue": "default",
                "Spark_DriverCores": 4
            }
        },
        {
            "info": {
                "id": "example-gbafe1-e3rr",
                "name": "test example2",
                "category": "spark",
                "moduleId": "f9f1ba97-477c-4a11-9650-016d1999cc4e",
                "description": "test"
            },
            "parameters": {
                "App_JarRelativePath": "UserlogLog4jExample.jar",
                "App_MainClass": "mt.example.Log4jUserLogExample",
                "Job_DelHDFSDataOnSucc": "false",
                "Job_MaxRetryNum": 1,
                "Job_Queue": "default",
                "Spark_DriverCores": 4
            }
        },
    ]
}
```

### Get example info

*Request*
```json
GET api/v2/mp/examples/:exampleId
Headers: {
    Authorization: 'Bearer ${token}',
}
```

*Response if succeeded*
```json
Status: 200
{
  "info": {
      "id": "example-gbafe1-e3rr",
      "name": "test example2",
      "category": "spark",
      "moduleId": "f9f1ba97-477c-4a11-9650-016d1999cc4e",
      "description": "test"
  },
  "parameters": {
      "App_JarRelativePath": "UserlogLog4jExample.jar",
      "App_MainClass": "mt.example.Log4jUserLogExample",
      "Job_DelHDFSDataOnSucc": "false",
      "Job_MaxRetryNum": 1,
      "Job_Queue": "default",
      "Spark_DriverCores": 4
  }
}
```

### Create example

*Request*
```json
POST api/v2/mp/examples
Headers: {
    Authorization: 'Bearer ${token}',
}
```

*Response if succeeded*
```json
Status: 200
{
    "result": "success"
}
```

### Delete example

*Request*
```json
DELETE /api/v2/mp/examples/:exampleId
Headers: {
    Authorization: 'Bearer ${token}',
}
```

*Response if succeeded*
```json
Status: 200
{
    "result": "success"
}
```

### Update example

*Request*
```json
PUT /api/v2/mp/examples/:exampleId'
Headers: {
    Authorization: 'Bearer ${token}',
}
```

*Response if succeeded*
```json
Status: 200
{
    "result": "success"
}
```


### `GET sub-clusters`

Get the list of subClusters.

*Request*

```json
GET /api/v1/subClusters
Headers: {
    Authorization: 'Bearer ${token}',
}
```

*Response if succeeded*

```json
Status: 200

{
    "Clusters": [
        {
            "Name": "CO4-0",
            "RestServerUri": "http://RestServer0-iVIP.Yarn-Prod-Co4.Co4.ap.gbl:9186",
            "hdfsUri": "hdfs://namenode0-ivip.yarn-prod-co4.co4.ap.gbl",
            "webHdfsUri": "http://namenode0-ivip.yarn-prod-co4.co4.ap.gbl:80",
            "HttpFSUri": "http://httpfs-ivip.yarn-prod-co4.co4.ap.gbl:82",
            "HttpFSAPIPath": "/webhdfs/v1/CO4",
            "FileUploadMethod": "HTTPFS",
            "subCluster": "BASIC-PROD-CO4-0",
            "proxyUri": "https://magnetar/cache",
            ...
        },
        {
            "Name": "CO4-1",
            "RestServerUri": "http://RestServer1-iVIP.Yarn-Prod-Co4.Co4.ap.gbl:9186",
            "hdfsUri": "hdfs://namenode1-ivip.yarn-prod-co4.co4.ap.gbl",
            "webHdfsUri": "http://namenode1-ivip.yarn-prod-co4.co4.ap.gbl:80",
            "HttpFSUri": "http://httpfs-ivip.yarn-prod-co4.co4.ap.gbl:82",
            "HttpFSAPIPath": "/webhdfs/v1/CO4-1",
            "FileUploadMethod": "HTTPFS",
            "subCluster": "BASIC-PROD-CO4-1",
            "proxyUri": "https://magnetar/cache",
            ...
        },
        {
            "Name": "CO4-2",
            "RestServerUri": "http://RestServer2-iVIP.Yarn-Prod-Co4.Co4.ap.gbl:9186",
            "hdfsUri": "hdfs://namenode2-ivip.yarn-prod-co4.co4.ap.gbl",
            "webHdfsUri": "http://namenode2-ivip.yarn-prod-co4.co4.ap.gbl:80",
            "HttpFSUri": "http://httpfs-ivip.yarn-prod-co4.co4.ap.gbl:82",
            "HttpFSAPIPath": "/webhdfs/v1/CO4-2",
            "FileUploadMethod": "HTTPFS",
            "subCluster": "BASIC-PROD-CO4-2",
            "proxyUri": "https://magnetar/cache",
            ...
        },
        {
            "Name": "CO4-3",
            "RestServerUri": "http://RestServer3-iVIP.Yarn-Prod-Co4.Co4.ap.gbl:9186",
            "hdfsUri": "hdfs://namenode3-ivip.yarn-prod-co4.co4.ap.gbl",
            "webHdfsUri": "http://namenode3-ivip.yarn-prod-co4.co4.ap.gbl:80",
            "HttpFSUri": "http://httpfs-ivip.yarn-prod-co4.co4.ap.gbl:82",
            "HttpFSAPIPath": "/webhdfs/v1/CO4-3",
            "FileUploadMethod": "HTTPFS",
            "subCluster": "BASIC-PROD-CO4-3",
            "proxyUri": "https://magnetar/cache",
            ...
        },
        {
            "Name": "CO4-4",
            "RestServerUri": "http://RestServer4-iVIP.Yarn-Prod-Co4.Co4.ap.gbl:9186",
            "hdfsUri": "hdfs://namenode4-ivip.yarn-prod-co4.co4.ap.gbl",
            "webHdfsUri": "http://namenode4-ivip.yarn-prod-co4.co4.ap.gbl:80",
            "HttpFSUri": "http://httpfs-ivip.yarn-prod-co4.co4.ap.gbl:82",
            "HttpFSAPIPath": "/webhdfs/v1/CO4-4",
            "FileUploadMethod": "HTTPFS",
            "subCluster": "BASIC-PROD-CO4-4",
            "proxyUri": "https://magnetar/cache",
            ...
        },
        ...
    ]
}
```

*Response if a server error occurred*

```json
Status: 500

{
  "code": "UnknownError",
  "message": "*Upstream error messages*"
}
```


### Get homedir

Get user job home dir path in HDFS. The user should upload his/her job related file here.

*Request*

```
GET /api/v2/mp/jobs/homeDir
Headers: {
  Authorization: "Bearer ${token}",
}
```

*Response if succeeded*

```json
Status: 200

{
  "homeDir": "/user/<userName>/MP/cache"
}
```

*Response if a server error occurred*

```json
Status: 500

{
  "code": "UnknownError",
  "message": "*Upstream error messages*"
}
```

### Get job group applications

Get applications of a job group

*Request*

```
GET /api/v2/mp/groups/:groupId/apps
Headers: {
  Authorization: "Bearer ${token}",
}
```
*Query Parameters*
```json
jobtype=
    JOBWRAPPER - add jobtype to filter
```


*Response if succeeded*

```json
Status: 200

{
  "apps": [{
    name: "jobName", // same as jobStatus
    appId: "application_id",
    username: "username",
    state: "job state",
    ......
  },
  ....
  ]
}
```

*Response if a server error occurred*

```json
Status: 500

{
  "code": "UnknownError",
  "message": "*Upstream error messages*"
}
```

### Stop a job group apps

Stop a job group by group id.

*Request*

```json
PUT /api/v2/mp/groups/:groupId/executionType
Headers: {
    Authorization: 'Bearer ${token}',
}
Body: {
    "value": "STOP"
}

```

*Response if succeeded*

```json
Status: 202

{
  "message": "Execute job group stop $groupId accepted, will stop the job shortly"
}
```

*Response if bad request*

```json
Status: 400

{
    "code": "UnknownError",
    "message": "Execute job group stop $groupId partially accepted will stop the job shortly,  but apps $appids will skip as no permision."
}
```

*Response if the job group does not exist*

```json
Status: 404

{
  "code": "NoJobError",
  "message": "Job group $groupId is not found."
}
```

*Response if a server error occurred*

```json
Status: 500

{
  "code": "UnknownError",
  "message": "*Upstream error messages*"
}
```

### Get job log

Get log by appId.

*Request*

```
GET /api/v2/mp/jobs/appId/{appId}/dumpContainerLogs
Headers: {
  Authorization: "Bearer ${token}",
}
```
```
*Query Parameters*

```json
{
  "executorId": "optional, job executor id",
  "attemptId": "optional, job attempt id",
  "logFile": "required, job log file name, use "all" to get a log file list, otherwise use specific log file name, like "stderr"",
  "start": "required, the start position of log file",
  "end": "optional, the end position of log file",
  "jobStatus": "optional, job status, the value could be running or others",
  "logType": "optional, choose from `launcherAM` or `spark`, which means get launcher am container log or spark log"
}
```
```

*Response if succeeded*

```json
Status: 200

[
    {
        "fileName": "stderr",
        "fileLength": "19703",
        "content": "this is a test log content",
        "start": "-4096"
    }
]
```

*Response if a server error occurred*

```json
Status: 404

{
    "code": "NoLogError",
    "message": "*error message*"
}
```
```json
Example:
https://localhost/rest-server/api/v2/mp/jobs/appId/application_1593602600998_16164/dumpContainerLogs?executorId=19&jobStatus=Succeeded&attemptId=1&logFile=all&start=-4096
```

Get log by jobName.

*Request*

```
GET /api/v2/mp/jobs/jobName/:jobName/dumpContainerLogs
Headers: {
  Authorization: "Bearer ${token}",
}
```
```
*Query Parameters*

```json
{
    taskRoleName: "optional, task role name of job, if it is undefined, will use the first taskrole",
    taskIndex: "optional, task index of job, if it is undefined, will get the am log of launcher job",
    logFile: "required, job log file name, use "all" to get a log file list, otherwise use specific log file name, like "stderr"",
    "start": "required, the start position of log file",
    "end": "optional, the end position of log file",
    "containerLogUrl": "optional, the containerLogUrl of the container, if it is proviced, restserver will use this value to get container log instead of using taskRoleName and taskIndex"
}
```
```

*Response if succeeded*

```json
Status: 200

[
    {
        "fileName": "stderr",
        "fileLength": "19703",
        "content": "this is a test log content",
        "start": "-4096"
    }
]
```

*Response if a server error occurred*

```json
Status: 404

{
    "code": "NoLogError",
    "message": "*error message*"
}
```
```json
example:
https://localhost/rest-server/api/v2/mp/jobs/jobName/FL_abcd_4bcc-85f8-eb87b8d0cbb5___-Official--TensorFlowOnYa___7ffb98e8___7-5-2020_09-42-25_AM/dumpContainerLogs?taskIndex=undefined&taskRoleName=undefined&logFile=all&start=-4096
```

### Get heapDump for a job container 

Get heapDump by appId.

*Request*

```
GET /api/v2/mp/jobs/appId/{appId}/heapDumpContainer
Headers: {
  Authorization: "Bearer ${token}",
}
```
```
*Query Parameters*

```json
{
  "executorId": "optional, job executor id",
  "attemptId": "optional, job attempt id",
  "isLive":"optional, default true"
}
```
```

*Response if succeeded*

```json
Status: 200

{Heap dump success}
```

*Response if a server error occurred*

```json
Status: 500

{
    "code": "NoDumpError",
    "message": "*error message*"
}
```


Get heapDump  by jobName.

*Request*

```
GET /api/v2/mp/jobs/jobName/:jobName/heapDumpContainer
Headers: {
  Authorization: "Bearer ${token}",
}
```
```
*Query Parameters*

```json
{   taskRoleName: "optional, task role name of job, if it is undefined, will use the first taskrole",
    taskIndex: "optional, task index of job, if it is undefined, will get the am log of launcher job",
    isLive:"optional, default true"
}
```
```

*Response if succeeded*

```json
Status: 200

{Heap dump success}
```

*Response if a server error occurred*

```json
Status: 500

{
    "code": "NoDumpError",
    "message": "*error message*"
}
```

### Get threadDump for a job container 

Get threadDump by appId.

*Request*

```
GET /api/v2/mp/jobs/appId/{appId}/threadDumpContainer
Headers: {
  Authorization: "Bearer ${token}",
}
```
```
*Query Parameters*

```json
{
    "executorId": "optional, job executor id",
    "attemptId": "optional, job attempt id",
}
```
```

*Response if succeeded*

```json
Status: 200

[
    {
        "threadId":5,
        "threadName":"Attach Listener",
        "threadState":"RUNNABLE",
        "stackTrace":{
            "elems":[

            ]
        },
        "blockedByLock":"",
        "holdingLocks":[

        ]
    }
]
```

*Response if a server error occurred*

```json
Status: 500

{
    "code": "NoDumpError",
    "message": "*error message*"
}
```


Get threadDump  by jobName.

*Request*

```
GET /api/v2/mp/jobs/jobName/:jobName/threadDumpContainer
Headers: {
  Authorization: "Bearer ${token}",
}
```
```
*Query Parameters*

```json
{
    taskRoleName: "optional, task role name of job, if it is undefined, will use the first taskrole",
    taskIndex: "optional, task index of job, if it is undefined, will get the am log of launcher job"
 }
```
```

*Response if succeeded*

```json
Status: 200

[
    {
        "threadId":5,
        "threadName":"Attach Listener",
        "threadState":"RUNNABLE",
        "stackTrace":{
            "elems":[

            ]
        },
        "blockedByLock":"",
        "holdingLocks":[

        ]
    }
]
```

*Response if a server error occurred*

```json
Status: 500

{
    "code": "NoDumpError",
    "message": "*error message*"
}
```

### Get processTreeDump for a job container 

Get processTreeDump by appId.

*Request*

```
GET /api/v2/mp/jobs/appId/{appId}/pTreeDumpContainer
Headers: {
  Authorization: "Bearer ${token}",
}
```
```
*Query Parameters*

```json
{
   "executorId": "optional, job executor id",
   "attemptId": "optional, job attempt id",
   "isAllContainers": "optional, true/false, default false, get all container taskList on the node when it is true"
}
```
```

*Response if succeeded*

```json
Status: 200

[
    {
        "PhysicalMemoryUtilization": 285,
        "ContainerId": "container_1596680483647_0002_01_000001",
        "TotalMemoryNeeded": 2048,
        "TotalVCoresNeeded": 1,
        "CpuVCoresUtilization": 0.016,
        "processTreeDump": "\t|- PID CPU_TIME(MILLIS) VMEM(BYTES) WORKING_SET(BYTES)\r\n\t|- 19964 31 4091904 4837376\r\n\t|- 27520 15 1482752 5320704\r\n\t|- 8436 14750 464158720 289128448\r\n",
        "VirtualMemoryUtilization": 447
    }
]
```

*Response if a server error occurred*

```json
Status: 500

{
    "code": "NoDumpError",
    "message": "*error message*"
}
```

Get processTreeDump  by jobName.

*Request*

```
GET /api/v2/mp/jobs/jobName/:jobName/pTreeDumpContainer
Headers: {
  Authorization: "Bearer ${token}",
}
```
```
*Query Parameters*

```json
{
    taskRoleName: "optional, task role name of job, if it is undefined, will use the first taskrole",
    taskIndex: "optional, task index of job, if it is undefined, will get the am log of launcher job",
    isAllContainers: "optional, true/false, default false, get all container taskList on the node when it is true"
}
```
```

*Response if succeeded*

```json
Status: 200

[
    {
        "PhysicalMemoryUtilization": 285,
        "ContainerId": "container_1596680483647_0002_01_000001",
        "TotalMemoryNeeded": 2048,
        "TotalVCoresNeeded": 1,
        "CpuVCoresUtilization": 0.016,
        "processTreeDump": "\t|- PID CPU_TIME(MILLIS) VMEM(BYTES) WORKING_SET(BYTES)\r\n\t|- 19964 31 4091904 4837376\r\n\t|- 27520 15 1482752 5320704\r\n\t|- 8436 14750 464158720 289128448\r\n",
        "VirtualMemoryUtilization": 447
    }
]
```

*Response if a server error occurred*

```json
Status: 500

{
    "code": "NoDumpError",
    "message": "*error message*"
}
```

###  Download container dump file  for a job container 

Download container dump file by appId.

*Request*

```
GET /api/v2/mp/jobs/appId/{appId}/containerDumpFileUrl
Headers: {
  Authorization: "Bearer ${token}",
}
```
```
*Query Parameters*

```json
{
  "executorId": "required, job executor id",
  "attemptId": "required, job attempt id",
  "logFile": "required, job log file name, use "all" to get a log file list, otherwise use specific log file name, like "stderr"",
  "jobStatus": "optional, job status, the value could be running or others",
  "logType": "optional, choose from `launcherAM` or `spark`, which means get launcher am container log or spark log"

}
```
```

*Response if succeeded*

```json
Status: 200

"http://jobhistory-ivip.yarn-prod-bn2.bn2.ap.gbl/ws/v1/applicationhistory/containerlogs/container_e294_1595350220520_13050_01_000003/test.hprof?download_dump_file=true"
```

*Response if a server error occurred*

```json
Status: 404

{
    "code": "NoLogError",
    "message": "*error message*"
}
```

Download container dump file by jobName.

*Request*

```
GET /api/v2/mp/jobs/jobName/:jobName/containerDumpFileUrl
Headers: {
  Authorization: "Bearer ${token}",
}
```
```
*Query Parameters*

```json
{
    "taskRoleName": "optional, task role name of job, if it is undefined, will use the first taskrole",
    "taskIndex": "optional, task index of job, if it is undefined, will get the am log of launcher job",
    "logFile": "required, job log file name, use "all" to get a log file list, otherwise use specific log file name, like "stderr"",
    "jobStatus": "optional, job status, the value could be running or others"
}
```
```

*Response if succeeded*

```json
Status: 200

"http://Proxy1-iVIP.Yarn-Prod-Bn2.BN2.ap.gbl:81/proxy/nodemanager/BN2AAP3399993E9/8042/ws/v1/node/containerlogs/container_e294_1595350220520_12574_01_000023/chaoch/1364.bin?download_dump_file=true"
```

*Response if a server error occurred*

```json
Status: 404

{
    "code": "NoLogError",
    "message": "*error message*"
}
```

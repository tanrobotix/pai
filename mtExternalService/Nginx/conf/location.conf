#
# API servers
#
# dns loaded in dns.conf
# backend net
# resolver 25.71.142.145 25.71.179.22 25.71.163.70 valid=300s ipv6=off;

# corpnet
# resolver 10.50.50.50 10.50.10.50 valid=300s ipv6=off;

# proxy config
proxy_set_header X-Real-IP $remote_addr;
proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

# enable http compress
gzip on;
gzip_min_length 1k;
gzip_types text/plain text/javascript text/css application/javascript application/x-javascript application/xml application/json;
gzip_vary on;

# for nodejs debug
location /sockjs-node {
    proxy_pass http://localhost:9286; 
    proxy_redirect off;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header X-Real-IP  $remote_addr;
    proxy_set_header X-Forwarded-For $remote_addr;
    proxy_set_header Host $host;
}

# proxy for all rest-server
location ~ ^/proxy/(.*)$ {

  #/proxy/http://RestServer1-iVIP.Yarn-Prod-Co4.Co4.ap.gbl:9186/api/v2/mergedJobs
  # -> http://RestServer1-iVIP.Yarn-Prod-Co4.Co4.ap.gbl:9186/api/v2/mergedJobs
  rewrite ^/proxy/(https?):/([^/]+)/(.*)$  /$3 break;
  proxy_pass $1://$2 ;
  proxy_set_header HOST $2;
  
  #rewrite rule for logout redirect
  #https://login.microsoftonline.com/common/oauth2/logout?post_logout_redirect_uri=http://magnetar:9286/
  proxy_redirect ~(https://login\.microsoftonline\.com/common/oauth2/logout\?post_logout_redirect_uri=)http://(.*):9286/ $1https://$http_host/ ;
  
  # proxy_set_header Accept-Encoding "";
  # sub_filter_types application/json application/javascript;
  # sub_filter_once off;
  # sub_filter http://RestServer https://$http_host/proxy/http://RestServer ;
}

# proxy for all shs request has &enableCache=true subfix, work as debugproxy-server
location ~ ^/cache/(.*)$ {

  #https://localhost/cache/Proxy0-iVIP.Yarn-Prod-CO4.CO4.ap.gbl:81/proxy/application_1580768556161_0091
  #/cache/(((?!\.ap\.gbl)[^/:])+)(.ap.gbl)?([^/]*)/(.*)
  
  rewrite ^/cache/(https?):/([^/]+)/(.*)$  /$3 break;
  proxy_pass $1://$2 ;
  proxy_set_header HOST $2;
  
  #for some long delay query
  proxy_read_timeout 600s;
  # for webhdfs upload file
  proxy_request_buffering off;
  
  include cache_location.conf;
}

# static image
location ~ ^/images/ {
    root   html;
    index  index.html index.htm;
}

# PAI REST server
location ~ ^/rest-server/api(.*)$ {
  proxy_pass http://127.0.0.1:9186/api$1$is_args$args;
  proxy_redirect http://127.0.0.1:9186/api http://127.0.0.1:9186/api;
}

# for tracking url rewrite
# https://magnetar/tracking/BN1-1/proxy/application_1594658924156_0134/YARN/TestLaunchTask
# https://magnetar/tracking/BN1-1/proxy/application_1594658924156_0118/LAUNCHER/[testLauncher]_[0]_[CLI]_[25.79.253.209]_[Unknown]
# https://magnetar/tracking/BN1-1/proxy/application_1594658924156_0117/SPARK/MultiVMTestLoad
location ~ ^/tracking/(.*)$ {
  rewrite ^/tracking/([^/]+)/proxy/([^/]+)/YARN/([^/]+)   /job-detail.html?jobName=$3&subCluster=$1 redirect ;
  rewrite ^/tracking/([^/]+)/proxy/([^/]+)/LAUNCHER/\[(.*?)\]([^/]+)   /job-detail.html?jobName=$3&subCluster=$1 redirect ;
  rewrite ^/tracking/([^/]+)/proxy/([^/]+)/SPARK/([^/]+)  /job-detail.html?appId=$2&subCluster=$1 redirect ;
  return 404 ;
}

# default proxy to webportal
location @webportal {

  proxy_pass http://localhost:9286;
  proxy_redirect default;
  proxy_set_header HOST $host;
  proxy_set_header Referer $http_referer;
  proxy_set_header X-Forwarded-Proto $scheme;
  
  # proxy_set_header Accept-Encoding "";
  # sub_filter_types application/javascript;
  # sub_filter_once off;
  # sub_filter http://RestServer https://$http_host/proxy/http://RestServer ;
}

# in product, webportal page served as static pages in directory webportal
# which copied from dist directory produced by build in webportal
# in local debug, directory webportal is empty, so request proxy to webportal node server
location / {
    # try get page from webportal directory, if not exist then proxy pass to webportal node server
    try_files $uri /index.html @webportal;
    root   webportal;
    index  index.html index.htm;
}
